<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="张宇辰 (pw)"><title>setInterval 倒计时陷阱 · 张宇辰的博客</title><meta name="description" content="最近发现页面上的一个倒计时功能出现了比较大的误差，debug 之后发现误差是由于 setInterval 不能实现准确执行任务导致的，例如下面这个例子：
12345var now = +new Date();setInterval(function () &amp;#123;    now += 100; "><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="image-info">2019 年夏 @ 内蒙响沙湾</div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h1><a href="/2013/07/20/accurate-countdown-in-javascript/">setInterval 倒计时陷阱</a></h1></div><div class="post-content"><p>最近发现页面上的一个倒计时功能出现了比较大的误差，debug 之后发现误差是由于 <code>setInterval</code> 不能实现准确执行任务导致的，例如下面这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> now = +<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    now += <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'diff'</span>, now - (+<span class="built_in">Date</span>.now()));</span><br><span class="line">&#125;, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
    <div id="demo1">
        <button id="demo1Run">运行</button> <button id="demo1Stop">停止</button>
        <table>
            <tr>
                <td>执行次数：</td>
                <td id="demo1Count">0</td>
            </tr>
            <tr>
                <td>累计误差(ms)：</td>
                <td id="demo1Diff">0</td>
            </tr>
            <tr>
                <td>平均误差(ms)：</td>
                <td id="demo1Avg">0</td>
            </tr>
        </table>
    </div>
</blockquote>

<script type="text/javascript">
(function () {
    var timer = null;
    var countEl = document.getElementById('demo1Count');
    var diffEl = document.getElementById('demo1Diff');
    var avgEl = document.getElementById('demo1Avg');

    document.getElementById('demo1Run').onclick = function () {
        var count = 0;
        var now = +new Date();
        clearInterval(timer);
        timer = setInterval(function () {
            now += 100;
            count += 1;
            countEl.innerHTML = count;
            diffEl.innerHTML = now - (+Date.now());
            avgEl.innerHTML = (now - (+Date.now())) / count;
        }, 100);
    };

    document.getElementById('demo1Stop').onclick = function () {
        clearInterval(timer);
    };
}());
</script>

<p>在我的 chrome 浏览器上平均每次执行时会有 1ms 的延迟。由于这个延迟是累加的，当代码执行 1000 次时误差就积累到了 1 秒。</p>
<p>想到的解决方法就是在执行过程中不停的修正下一次运行函数的时间，由于<code>setInterval</code> 的间隔时间是在创建 <code>timer</code> 时指定的，所以就只能用 <code>setTimeout</code> 来实现定时器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> now = +<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    now += <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">var</span> fix = now - (+<span class="built_in">Date</span>.now());</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'diff:'</span>, fix)</span><br><span class="line"></span><br><span class="line">    setTimeout(run, <span class="number">100</span> + fix);</span><br><span class="line">&#125;, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
    <div id="demo2">
        <button id="demo2Run">运行</button> <button id="demo2Stop">停止</button>
        <table>
            <tr>
                <td>执行次数：</td>
                <td id="demo2Count">0</td>
            </tr>
            <tr>
                <td>误差(ms)：</td>
                <td id="demo2Diff">0</td>
            </tr>
            <tr>
                <td>平均每次执行误差(ms)：</td>
                <td id="demo2Avg">0</td>
            </tr>
        </table>
    </div>
</blockquote>

<script type="text/javascript">
(function () {
    var timer = null;
    var countEl = document.getElementById('demo2Count');
    var diffEl = document.getElementById('demo2Diff');
    var avgEl = document.getElementById('demo2Avg');

    document.getElementById('demo2Run').onclick = function () {
        var count = 0;
        var now = +new Date();
        clearInterval(timer);

        timer = setTimeout(function run() {
            now += 1000;

            var diff = now - (+Date.now());

            count += 1;
            countEl.innerHTML = count;
            diffEl.innerHTML = diff;
            avgEl.innerHTML = diff / count;

            timer = setTimeout(run, 1000 + diff);
        }, 1000);
    };

    document.getElementById('demo2Stop').onclick = function () {
        clearInterval(timer);
    };
}());
</script>

<p>用 <code>setTimeout</code> 就解决了 <code>setInterval</code> 误差累计的问题。</p>
<p>简单封装一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accurateInterval</span>(<span class="params">callback, interval</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> now = +<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        now += interval;</span><br><span class="line">        <span class="keyword">var</span> fix = now - (+<span class="built_in">Date</span>.now());</span><br><span class="line"></span><br><span class="line">        setTimeout(run, interval + fix);</span><br><span class="line"></span><br><span class="line">        callback();</span><br><span class="line">    &#125;, interval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>末尾，抛几块砖</p>
<ul>
<li>在 <code>accurateinterval</code> 函数中，是否可以先执行 <code>callback</code> 函数，再 <code>setTimeout</code>？</li>
<li>当 <code>callback</code> 函数的执行时间超过定时间隔后会出现什么事情？</li>
<li><code>accurateinterval</code> 实现的倒计时，会出现走时不均匀的问题。也就是说倒计时的数字会时快时慢，如何解决这个问题？</li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2013-07-20</span><i class="fa fa-tag"></i><a class="tag" href="/tags/javascript/" title="javascript">javascript </a></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2013/10/16/use-nodejs-as-web-frontend-server/" title="用 node.js 做 Web 前端服务器的一些经验">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2012/12/08/grunt-the-best/" title="Grunt -- 最好的前端构建框架">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>